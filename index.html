<!DOCTYPE html>
<html lang="ko">

<!-- Supabase JS SDK v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<head>
  <meta charset="UTF-8">
  <title>ğŸ§  ê¸°ì–µë ¥ ì±Œë¦°ì§€</title>

  <!-- PyScript ë¡œë” -->
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- â”€â”€â”€ ì´ë¦„ ì…ë ¥ & ì ìˆ˜íŒ â”€â”€â”€ -->
  <div id="start-panel">
    <h1>ğŸ§  ê¸°ì–µë ¥ ì±Œë¦°ì§€</h1>
    <p>ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ì‹œì‘!</p>
    <input id="player-name" placeholder="ë‹‰ë„¤ì„" autocomplete="off">
    <button id="start-btn">ê²Œì„ ì‹œì‘</button>
  </div>

  <!-- â”€â”€â”€ ê²Œì„ ì˜ì—­ â”€â”€â”€ -->
  <div id="game-panel" class="hidden">
    <h2 id="greet"></h2>
    <div id="image-area"></div>
    <div id="btn-area" class="hidden"></div>
    <p id="score-txt">ì ìˆ˜ 0 ì </p>
    <button id="end-btn">ê²Œì„ ëë‚´ê¸°</button>
  </div>

  <!-- â”€â”€â”€ ë­í‚¹ ë³´ë“œ â”€â”€â”€ -->
  <div id="rank-panel" class="hidden">
    <h2>ğŸ“Š ë­í‚¹</h2>
    <p id="final-score"></p>
    <h3>ì˜¤ëŠ˜ì˜ TOP 5</h3>
    <ol id="today-list"></ol>
    <h3>ì´ë²ˆ ì£¼ TOP 5</h3>
    <ol id="week-list"></ol>
    <button onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
  </div>

  <!-- â”€â”€â”€ PyScript ì„¸íŒ… â”€â”€â”€ -->
  <py-config>
    packages = []
  </py-config>

  <py-script>
import asyncio, random, json, js
from datetime import date
from pyodide.ffi import to_js  # ğŸ‘ˆ ì¶”ê°€
# ...
# â”€â”€ Supabase ì—°ê²° (URL, KEYëŠ” ë³¸ì¸ ê°’ìœ¼ë¡œ!) â”€â”€
SUPA_URL = "https://mohzlkulphbbsbfblvbp.supabase.co"
SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vaHpsa3VscGhiYnNiZmJsdmJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1OTAwMzAsImV4cCI6MjA2NjE2NjAzMH0.xflJ71baNaKh34gfxAyM70VR9fY1eVbjNNGBsGKmPQA"
supa = js.supabase.createClient(SUPA_URL, SUPA_KEY)



#########################
#     ì„¤ì •ê°’ & ë°ì´í„°    #
#########################
IMAGES = [

  {"src": "images/íŠ¸ë„ë„ë ˆë¡œ íŠ¸ë„ë„ë¼.jpg",   "name": "íŠ¸ë„ë„ë ˆë¡œ íŠ¸ë„ë„ë¼"},
  {"src": "images/í‰í‰í‰í‰í‰í‰í‰í‰í‰ì‚¬í›„ë¥´.jpg",   "name": "í‰í‰í‰í‰í‰í‰í‰í‰í‰ì‚¬í›„ë¥´"},
  {"src": "images/ë¸Œë¥´ë¥´ ë¸Œë¥´ë¥´ íŒŒíƒ€í•Œ.jpg", "name": "ë¸Œë¥´ë¥´ ë¸Œë¥´ë¥´ íŒŒíƒ€í•Œ"},
  {"src": "images/ë´„ë°”ë¥´ë””ë¡œ í¬ë¡œì½”ë”œë¡œ.jpg",   "name": "ë´„ë°”ë¥´ë””ë¡œ í¬ë¡œì½”ë”œë¡œ"},
  {"src": "images/ë³´ë„¤ì¹´ ì•”ë°œë¼ë¶€.jpg","name": "ë³´ë„¤ì¹´ ì•”ë°œë¼ë¶€"},
  {"src": "images/ë¦¬ë¦´ë¦¬ ë¼ë¦´ë¼.jpg", "name": "ë¦¬ë¦´ë¦¬ ë¼ë¦´ë¼"},
  
]
DISPLAY_MS  = 1200           # í•œ ì¥ë‹¹ ë…¸ì¶œì‹œê°„ (ms)
ROUNDS_MAX  = 5              # ë¼ìš´ë“œ ìˆ˜(ì •ë‹µ ì‹œ ê³„ì†)
POINTS_EACH = 10             # ì •ë‹µë‹¹ ì ìˆ˜

###############
#   ìœ í‹¸ í•¨ìˆ˜  #
###############
def get_ls(key, default):
    raw = js.window.localStorage.getItem(key)
    return json.loads(raw) if raw else default

def set_ls(key, value):
    js.window.localStorage.setItem(key, json.dumps(value))

def iso_week_str(d:date):
    y,w,_ = d.isocalendar()
    return f"{y}-{w:02d}"

###################
#  DOM ë‹¨ì¶• ë³€ìˆ˜   #
###################
d = js.document
start_p  = d["start-panel"]
game_p   = d["game-panel"]
rank_p   = d["rank-panel"]
name_in  = d["player-name"]
greet    = d["greet"]
img_box  = d["image-area"]
btn_box  = d["btn-area"]
scoretxt = d["score-txt"]
finaltxt = d["final-score"]
today_ul = d["today-list"]
week_ul  = d["week-list"]

###################
#   ê²Œì„ ë¡œì§      #
###################
player  = {"name": "", "score":0}
round_n = 0
sequence = []

def show(elem): elem.classList.remove("hidden")
def hide(elem): elem.classList.add("hidden")

async def show_sequence():
    for card in sequence:
        img = d.createElement("img"); img.src = card["src"]; img.className="card"
        img_box.appendChild(img)
        await asyncio.sleep(DISPLAY_MS/1000)
        img_box.removeChild(img)

def build_buttons():
    btn_box.innerHTML = ""
    targets = sequence.copy()
    for card in random.sample(sequence,len(sequence)):
        b = d.createElement("button")
        b.textContent = card["name"]; b.className="choice"
        async def handler(evt, c=card, t=targets):
            if c == t[0]:
                evt.target.classList.add("right")
                t.pop(0)
                if not t:  # ë¼ìš´ë“œ í´ë¦¬ì–´
                    await asyncio.sleep(.3)
                    btn_box.classList.add("hidden")
                    next_round()
            else:
                evt.target.classList.add("wrong")
                end_game()
        b.onclick = handler
        btn_box.appendChild(b)
    btn_box.classList.remove("hidden")

def update_score():
    scoretxt.textContent = f"ì ìˆ˜ {player['score']} ì "

def next_round():
    global round_n, sequence
    round_n += 1
    if round_n > ROUNDS_MAX:
        end_game(); return
    # ë‚œì´ë„ â†‘ : ë¼ìš´ë“œ ìˆ˜ë§Œí¼ ì´ë¯¸ì§€ ì‚¬ìš©
    sequence = random.sample(IMAGES, k=round_n+2)
    player['score'] += POINTS_EACH
    update_score()
    asyncio.ensure_future(run_round())

async def run_round():
    await asyncio.sleep(.5)
    await show_sequence()
    build_buttons()

###########
#  ì‹œì‘   #
###########
def start_game(event=None):
    nm = name_in.value.strip() or "ì†ë‹˜"
    player["name"]=nm
    greet.textContent = f"{nm}ë‹˜, í™”ì´íŒ…!"
    hide(start_p); show(game_p)
    next_round()

d["start-btn"].onclick = start_game
d["end-btn"].onclick = lambda evt: asyncio.ensure_future(end_game())

###########
#  ì¢…ë£Œ   #
###########
async def end_game():
    hide(game_p); show(rank_p)
    finaltxt.textContent = f"ğŸ§‘â€ğŸš€ {player['name']} ë‹˜ ì ìˆ˜: {player['score']} ì "
    await save_and_show_ranking()

async def save_and_show_ranking(): 
    today = date.today()
    week  = iso_week_str(today)

        # 1ï¸âƒ£ Supabaseì— ì ìˆ˜ ê¸°ë¡
    await store_score(player['name'], player['score'])

        # 2ï¸âƒ£ ë­í‚¹ ë°›ì•„ì˜¤ê¸°
    today_rank, week_rank = await fetch_leaderboards()

    # 3ï¸âƒ£ í™”ë©´ì— ì¶œë ¥
    def fill_list(arr, ul):
        ul.innerHTML=""
        for r in arr:
            li = d.createElement("li")
            li.textContent = f"{r['name']} â€” {r['score']}ì "
            ul.appendChild(li)
    fill_list(today_rank, today_ul)
    fill_list(week_rank , week_ul)

    # ì ìˆ˜ ì €ì¥
async def store_score(name:str, score:int):
    data = to_js({"name": name, "score": score})
    res  = await supa.from_("scores").insert(data).select().execute()
    if res.error:
        js.console.error(res.error)

# ì˜¤ëŠ˜ & ì´ë²ˆ ì£¼ TOP 5
async def fetch_leaderboards():
    today_iso = date.today().isoformat()          # '2025-06-22'
    y,w,_     = date.today().isocalendar()
    week_iso  = f"{y}-{w:02d}"                    # '2025-25'

    today_r = await (supa.from_("scores")
                     .select("*")
                     .eq("created_at::date", today_iso)
                     .order("score", {"ascending": False})
                     .limit(5)
                     .execute())

    week_r  = await (supa.from_("scores")
                     .select("*")
                     .like("to_char(created_at,'IYYY-IW')", week_iso)
                     .order("score", {"ascending": False})
                     .limit(5)
                     .execute())

    return today_r.data or [], week_r.data or []
  </py-script>

  <!-- â”€â”€â”€ ê°„ë‹¨ CSS (inline ë„£ì–´ë„ ìƒê´€ì—†ìŒ) â”€â”€â”€ -->
  <style>
  *{box-sizing:border-box}
  body{font-family:'Pretendard','Noto Sans KR',sans-serif;margin:0;padding:2rem;text-align:center}
  input,button{padding:.6rem 1rem;font-size:1rem;border-radius:8px;border:1px solid #ccc}
  button{cursor:pointer}
  #image-area{height:240px;display:flex;justify-content:center;align-items:center;margin-bottom:1rem}
  .card{width:200px;height:200px;border-radius:12px;object-fit:cover;box-shadow:0 4px 10px rgba(0,0,0,.2)}
  #btn-area{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-bottom:1rem}
  .choice{background:#f6f6f6}
  .right{background:#6abe6a;color:#fff!important}
  .wrong{background:#e04d4d;color:#fff!important}
  .hidden{display:none}
  #rank-panel ol{padding-left:1.2rem;text-align:left;display:inline-block}
  </style>
</body>
</html>
