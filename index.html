<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>🧠 이탈리안 브레인 기억력 챌린지 (현준,서준 Love)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="start-panel">
    <h1>🧠 기억력 채리지</h1>
    <p>닉네임을 입력하고 시작!</p>
    <input id="player-name" placeholder="닉네임" autocomplete="off">
    <button id="start-btn">게임 시작</button>
  </div>

  <div id="game-panel" class="hidden">
    <h2 id="greet"></h2>
    <div id="image-area"></div>
    <div id="btn-area" class="hidden"></div>
    <p id="score-txt">점수 0 점</p>
    <button id="end-btn">게임 끝내기</button>
  </div>

  <div id="rank-panel" class="hidden">
    <h2>📊 랭킹</h2>
    <p id="final-score"></p>
    <h3>오늘의 TOP 5</h3>
    <ol id="today-list"></ol>
    <h3>이번 주 TOP 5</h3>
    <ol id="week-list"></ol>
    <button onclick="location.reload()">다시 하기</button>
  </div>

  <script>
    const SUPA_URL = "https://mohzlkulphbbsbfblvbp.supabase.co";
    const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vaHpsa3VscGhiYnNiZmJsdmJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1OTAwMzAsImV4cCI6MjA2NjE2NjAzMH0.xflJ71baNaKh34gfxAyM70VR9fY1eVbjNNGBsGKmPQA";
    const client = supabase.createClient(SUPA_URL, SUPA_KEY);

    const IMAGES = [
      { src: 'tra.jpg', name: '트랄랄레로 트랄랄라' },
      { src: 'tung.jpg', name: '퉁퉁퉁퉁퉁퉁퉁퉁퉁사후르' },
      { src: 'br.jpg', name: '브르르 브르르 파타핌' },
      { src: 'bom.jpg', name: '봄바르디로 크로코딜로' },
      { src: 'bone.jpg', name: '보네카 암발라부' },
      { src: 'ririr.jpg', name: '리릴리 라랄라' },
    ];
    const DISPLAY_MS = 1200;
    const ROUNDS_MAX = 5;
    const POINTS_EACH = 10;

    const d = document;
    const startP = d.getElementById('start-panel');
    const gameP = d.getElementById('game-panel');
    const rankP = d.getElementById('rank-panel');
    const nameInput = d.getElementById('player-name');
    const greet = d.getElementById('greet');
    const imgBox = d.getElementById('image-area');
    const btnBox = d.getElementById('btn-area');
    const scoreTxt = d.getElementById('score-txt');
    const finalTxt = d.getElementById('final-score');
    const todayUl = d.getElementById('today-list');
    const weekUl = d.getElementById('week-list');

    let player = { name: '', score: 0 };
    let roundN = 0;
    let sequence = [];

    function show(elem) { elem.classList.remove('hidden'); }
    function hide(elem) { elem.classList.add('hidden'); }

    async function showSequence() {
      for (const card of sequence) {
        const img = d.createElement('img');
        img.src = card.src;
        img.className = 'card';
        imgBox.appendChild(img);
        await new Promise(r => setTimeout(r, DISPLAY_MS));
        img.remove();
      }
    }

    function buildButtons() {
      btnBox.innerHTML = '';
      const targets = [...sequence];
      for (const card of [...sequence].sort(() => Math.random() - 0.5)) {
        const b = d.createElement('button');
        b.textContent = card.name;
        b.className = 'choice';
        b.onclick = async () => {
          if (card.name === targets[0].name) {
            b.classList.add('right');
            targets.shift();
            if (targets.length === 0) {
              await new Promise(r => setTimeout(r, 300));
              btnBox.classList.add('hidden');
              nextRound();
            }
          } else {
            b.classList.add('wrong');
            endGame();
          }
        };
        btnBox.appendChild(b);
      }
      btnBox.classList.remove('hidden');
    }

    function updateScore() {
      scoreTxt.textContent = `점수 ${player.score} 점`;
    }

    function nextRound() {
      roundN++;
      if (roundN > ROUNDS_MAX) {
        endGame(); return;
      }
      sequence = IMAGES.sort(() => 0.5 - Math.random()).slice(0, roundN + 2);
      player.score += POINTS_EACH;
      updateScore();
      runRound();
    }

    async function runRound() {
      await new Promise(r => setTimeout(r, 500));
      await showSequence();
      buildButtons();
    }

    function startGame() {
      player.name = nameInput.value.trim() || '손님';
      greet.textContent = `${player.name}님, 화이팅!`;
      hide(startP); show(gameP);
      nextRound();
    }

    async function endGame() {
      hide(gameP); show(rankP);
      finalTxt.textContent = `🧑‍🚀 ${player.name} 님 점수: ${player.score} 점`;
      await storeScore(player.name, player.score);
      await showRankings();
    }

    async function storeScore(name, score) {
      await client.from('scores').insert([{ name, score }]);
    }

    async function showRankings() {
      const today = new Date().toISOString().split('T')[0];
      const [year, month, day] = today.split('-');
      const currentWeek = new Date().getFullYear() + '-' + String(getWeekNumber(new Date())).padStart(2, '0');

      const todayRank = await client
        .from('scores')
        .select('*')
        .like('created_at', `${today}%`)
        .order('score', { ascending: false })
        .limit(5);

      const weekRank = await supabase
        .from('scores')
        .select('*')
        .like("to_char(created_at,'IYYY-IW')", currentWeek)
        .order('score', { ascending: false })
        .limit(5);

      const fillList = (ul, data) => {
        ul.innerHTML = '';
        (data.data || []).forEach(r => {
          const li = d.createElement('li');
          li.textContent = `${r.name} — ${r.score}점`;
          ul.appendChild(li);
        });
      };

      fillList(todayUl, todayRank);
      fillList(weekUl, weekRank);
    }

    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    d.getElementById('start-btn').onclick = startGame;
    d.getElementById('end-btn').onclick = endGame;
  </script>

  <style>
    *{box-sizing:border-box}
    body{font-family:'Pretendard','Noto Sans KR',sans-serif;margin:0;padding:2rem;text-align:center}
    input,button{padding:.6rem 1rem;font-size:1rem;border-radius:8px;border:1px solid #ccc}
    button{cursor:pointer}
    #image-area{height:240px;display:flex;justify-content:center;align-items:center;margin-bottom:1rem}
    .card{width:200px;height:200px;border-radius:12px;object-fit:cover;box-shadow:0 4px 10px rgba(0,0,0,.2)}
    #btn-area{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-bottom:1rem}
    .choice{background:#f6f6f6}
    .right{background:#6abe6a;color:#fff!important}
    .wrong{background:#e04d4d;color:#fff!important}
    .hidden{display:none}
    #rank-panel ol{padding-left:1.2rem;text-align:left;display:inline-block}
  </style>
</body>
</html>
