<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>ğŸ§  ì´íƒˆë¦¬ì•ˆ ë¸Œë ˆì¸ ê¸°ì–µë ¥ ì±Œë¦°ì§€ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="start-panel">
    <h1>ğŸ§  ê¸°ì–µë ¥ ì±Œë¦°ì§€ ğŸ§  í˜„ì¤€ì„œì¤€ Love</h1>
    <p>ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ì‹œì‘!</p>
    <input id="player-name" placeholder="ë‹‰ë„¤ì„" autocomplete="off">
    <button id="start-btn">ê²Œì„ ì‹œì‘</button>
  </div>

  <div id="game-panel" class="hidden">
    <h2 id="greet"></h2>
    <div id="image-area"></div>
    <div id="btn-area" class="hidden"></div>
    <p id="score-txt">ì ìˆ˜ 0 ì </p>
    <button id="end-btn">ê²Œì„ ëë‚´ê¸°</button>
  </div>

  <div id="rank-panel" class="hidden">
    <h2>ğŸ“Š ë­í‚¹</h2>
    <p id="final-score"></p>
    <h3>ì˜¤ëŠ˜ì˜ TOP 5</h3>
    <ol id="today-list"></ol>
    <h3>ì´ë²ˆ ì£¼ TOP 5</h3>
    <ol id="week-list"></ol>
    <button onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
  </div>

  <script>
    const SUPA_URL = "https://mohzlkulphbbsbfblvbp.supabase.co";
    const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vaHpsa3VscGhiYnNiZmJsdmJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1OTAwMzAsImV4cCI6MjA2NjE2NjAzMH0.xflJ71baNaKh34gfxAyM70VR9fY1eVbjNNGBsGKmPQA";
    const client = supabase.createClient(SUPA_URL, SUPA_KEY);

    const IMAGES = [
      { src: 'tra.jpg', name: 'íŠ¸ë„ë„ë ˆë¡œ íŠ¸ë„ë„ë¼' },
      { src: 'tung.jpg', name: 'í‰í‰í‰í‰í‰í‰í‰í‰í‰ì‚¬í›„ë¥´' },
      { src: 'br.jpg', name: 'ë¸Œë¥´ë¥´ ë¸Œë¥´ë¥´ íŒŒíƒ€í•Œ' },
      { src: 'bom.jpg', name: 'ë´„ë°”ë¥´ë””ë¡œ í¬ë¡œì½”ë”œë¡œ' },
      { src: 'bone.jpg', name: 'ë³´ë„¤ì¹´ ì•”ë°œë¼ë¶€' },
      { src: 'ririr.jpg', name: 'ë¦¬ë¦´ë¦¬ ë¼ë¦´ë¼' },
      { src: 'Chim.jpg', name: 'ì¹¨íŒì§€ë‹ˆ ë°”ë‚˜ë‹ˆë‹ˆ' },
      { src: 'Bombom.jpg', name: 'ë´„ë´„ë¹„ë‹ˆ êµ¬ì§€ë‹ˆ' },
      { src: 'Cappu.jpg', name: 'ì¹´í‘¸ì¹˜ë…¸ ì•„ì‚¬ì‹œë…¸' },
      { src: 'Trippi.jpg', name: 'íŠ¸ë¦¬í”¼ íŠ¸ë¡œí”¼' },
      { src: 'Frigo.jpg', name: 'í”„ë¦¬ê³  ì¹´ë©œë¡œ' },
      { src: 'LaVaca.jpg', name: 'ë¼ ë°”ì¹´ ì‚¬íˆ¬ë¥´ë…¸ ì‚¬íˆ¬ë¥´ë‹ˆíƒ€' },
      { src: 'Ballerina.jpg', name: 'ë°œë ˆë¦¬ë‚˜ ì¹´í‘¸ì¹˜ë‚˜' },
      { src: 'Udindin.jpg', name: 'ì˜¤ ë”˜ë”˜ë”˜ë”˜ ë‘” ë§ˆ ë”˜ë”˜ë”˜ ë‘”' },
      { src: 'Truli.jpg', name: 'íŠ¸ë£°ë¦¬ë©”ë¡œ íŠ¸ë£°ë¦¬ì¹˜ë‚˜' },
      { src: 'Girafa.jpg', name: 'ì§€ë¼íŒŒ ì²¼ë ˆìŠ¤í…Œ' },
      { src: 'Bobri.jpg', name: 'ë³´ë¸Œë¦¬í†  ë°˜ë””í† ' },
      { src: 'Tatata.jpg', name: 'íƒ€íƒ€íƒ€íƒ€íƒ€íƒ€íƒ€íƒ€íƒ€íƒ€íƒ€ ì‚¬í›„ë¥´' },
      { src: 'Pot.jpg', name: 'íŒŸ í•«ìŠ¤íŒŸ' },
      { src: 'Frulli.jpg', name: 'í”„ë£°ë¦¬ í”„ë£°ë¼' },
      { src: 'Brribrri.jpg', name: 'ë¸Œë¦¬ ë¸Œë¦¬ ë¹„ì¿ ìŠ¤ ë””ì¿ ìŠ¤ ë´„ë¹„ì¿ ìŠ¤' },
      { src: 'rTricTrac.jpg', name: 'íŠ¸ë¦­ íŠ¸ë™ ë°”ë¼ë¶' },
      { src: 'Burbal.jpg', name: 'ë¶€ë¥´ë°œë¡œë‹ˆ ë£°ë¦´ë¡¤ë¦¬' },
      { src: 'Orangut.jpg', name: 'ì˜¤ë‘êµ¬í‹°ë‹ˆ ì•„ë‚˜ë‚˜ì‹œë‹ˆ' },
      { src: 'Garama.jpg', name: 'ê°€ë¼ë§ˆë¼ë¼ë§ˆë¼ë¼ë§Œ ë‹¨ ë§ˆë‘ë‘¥ë‘¥ íƒ íˆ°í‰ í¼ë¥´ì¿¤í‰' },
      { src: 'ilcacto.jpg', name: 'ì¼ ì¹µí†  íˆí¬í¬íƒ€ëª¨' },
      { src: 'Blueberri.jpg', name: 'ë¸”ë£¨ë² ë¦¬ë‹ˆ ì˜¥í† í‘¸ì‹œë‹ˆ' },
      { src: 'Glorbo.jpg', name: 'ê¸€ë¡œë¥´ë³´ í”„ë£¨í† ë“œë¦´ë¡œ' },
      { src: 'Rhino.jpg', name: 'ë¦¬ë…¸ í† ìŠ¤íŠ¸ë¦¬ë…¸' },
      { src: 'Zibra.jpg', name: 'ì§€ë¸Œë¼ ì£¼ë¸Œë¼ ì§€ë¸Œë¼ë¦¬ë‹ˆ' },
      { src: 'Graip.jpg', name: 'ê·¸ë¼ì´í‘¸ì‹œ ë©”ë‘ì‹œ' },
      { src: 'Tigrru.jpg', name: 'í‹°ê·¸ë£°ë¦¬ë‹ˆ ì›Œí„°ë©œë¦¬ë‹ˆ' },
      { src: 'Gorillo.jpg', name: 'ê³ ë¦´ë¡œ ì›Œí„°ë©œë¡ ë“œë¦´ë¡œ' },
      { src: 'Bananita.jpg', name: 'ë°”ë‚˜ë‹ˆíƒ€ ëŒí”¼ë‹ˆíƒ€' },
      { src: 'Cocofa.jpg', name: 'ì½”ì½”íŒí†  ì—˜ë ˆíŒí† ' },
      { src: 'Tigrulligr.jpg', name: 'í‹°ê·¸ë£°ë¦¬ ê·¸ë ˆì´í”„ë£¨íˆ¬ë‹ˆ' },    // ë‚˜ë¬´ìœ„í‚¤ 2.37 ê¹Œì§€ ì…ë ¥

    ];
    const DISPLAY_MS = 1600;
    const ROUNDS_MAX = 10;
    const POINTS_EACH = 10;

    const d = document;
    const startP = d.getElementById('start-panel');
    const gameP = d.getElementById('game-panel');
    const rankP = d.getElementById('rank-panel');
    const nameInput = d.getElementById('player-name');
    const greet = d.getElementById('greet');
    const imgBox = d.getElementById('image-area');
    const btnBox = d.getElementById('btn-area');
    const scoreTxt = d.getElementById('score-txt');
    const finalTxt = d.getElementById('final-score');
    const todayUl = d.getElementById('today-list');
    const weekUl = d.getElementById('week-list');

    let player = { name: '', score: 0 };
    let roundN = 0;
    let sequence = [];

    function show(elem) { elem.classList.remove('hidden'); }
    function hide(elem) { elem.classList.add('hidden'); }

    function getStartOfWeek(date = new Date()) {
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(date.setDate(diff));
    }

    async function showSequence() {
      for (const card of sequence) {
        const img = d.createElement('img');
        img.src = card.src;
        img.className = 'card';
        imgBox.appendChild(img);
        await new Promise(r => setTimeout(r, DISPLAY_MS));
        img.remove();
      }
    }

    function buildButtons() {
      btnBox.innerHTML = '';
      const targets = [...sequence];
      for (const card of [...sequence].sort(() => Math.random() - 0.5)) {
        const b = d.createElement('button');
        b.textContent = card.name;
        b.className = 'choice';
        b.onclick = async () => {
          if (card.name === targets[0].name) {
            b.classList.add('right');
            targets.shift();
            if (targets.length === 0) {
              await new Promise(r => setTimeout(r, 300));
              btnBox.classList.add('hidden');
              nextRound();
            }
          } else {
            b.classList.add('wrong');
            endGame();
          }
        };
        btnBox.appendChild(b);
      }
      btnBox.classList.remove('hidden');
    }

    function updateScore() {
      scoreTxt.textContent = `ì ìˆ˜ ${player.score} ì `;
    }

    function nextRound() {
      roundN++;
      if (roundN > ROUNDS_MAX) {
        endGame(); return;
      }
      sequence = IMAGES.sort(() => 0.5 - Math.random()).slice(0, roundN + 2);
      player.score += POINTS_EACH;
      updateScore();
      runRound();
    }

    async function runRound() {
      await new Promise(r => setTimeout(r, 500));
      await showSequence();
      buildButtons();
    }

    function startGame() {
      player.name = nameInput.value.trim() || 'ì†ë‹˜';
      greet.textContent = `${player.name}ë‹˜, í™”ì´íŒ…!`;
      hide(startP); show(gameP);
      nextRound();
    }

    async function endGame() {
      hide(gameP); show(rankP);
      finalTxt.textContent = `ğŸ§‘â€ğŸš€ ${player.name} ë‹˜ ì ìˆ˜: ${player.score} ì `;
      await storeScore(player.name, player.score);
      await showRankings();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function storeScore(name, score) {
      await client.from('scores').insert([{ name, score }]);
    }

    async function showRankings() {
      const today = new Date();
      const startOfDay = new Date(today.setHours(0, 0, 0, 0)).toISOString();
      const endOfDay = new Date(today.setHours(23, 59, 59, 999)).toISOString();

      const todayRank = await client
        .from('scores')
        .select('*')
        .gte('created_at', startOfDay)
        .lte('created_at', endOfDay)
        .order('score', { ascending: false })
        .limit(5);

      const weekStart = new Date(getStartOfWeek());
      const startOfWeek = new Date(weekStart.setHours(0, 0, 0, 0)).toISOString();
      const endOfToday = new Date().toISOString();

      const weekRank = await client
        .from('scores')
        .select('*')
        .gte('created_at', startOfWeek)
        .lte('created_at', endOfToday)
        .order('score', { ascending: false })
        .limit(5);

      const fillList = (ul, data) => {
        ul.innerHTML = '';
        (data.data || []).forEach(r => {
          const li = d.createElement('li');
          li.textContent = `${r.name} â€” ${r.score}ì `;
          ul.appendChild(li);
        });
      };

      fillList(todayUl, todayRank);
      fillList(weekUl, weekRank);
    }

    d.getElementById('start-btn').onclick = startGame;
    d.getElementById('end-btn').onclick = endGame;
  </script>

  <style>
    * { box-sizing: border-box }
    body {
      font-family: 'Pretendard','Noto Sans KR',sans-serif;
      margin: 0; padding: 2rem; text-align: center;
    }
    input, button {
      padding: .6rem 1rem; font-size: 1rem;
      border-radius: 8px; border: 1px solid #ccc
    }
    button { cursor: pointer }
    #image-area {
      height: 240px; display: flex;
      justify-content: center; align-items: center;
      margin-bottom: 1rem
    }
    .card {
      width: 200px; height: 200px;
      border-radius: 12px; object-fit: cover;
      box-shadow: 0 4px 10px rgba(0,0,0,.2)
    }
    #btn-area {
      display: flex; gap: .5rem; flex-wrap: wrap;
      justify-content: center; margin-bottom: 1rem
    }
    .choice { background: #f6f6f6 }
    .right { background: #6abe6a; color: #fff !important }
    .wrong { background: #e04d4d; color: #fff !important }
    .hidden { display: none }
    #rank-panel ol {
      padding-left: 1.2rem; text-align: left; display: inline-block
    }
  </style>
</body>
</html>
